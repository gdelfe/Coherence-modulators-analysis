
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% This code computes the theta coherence between the modulator-sender and
% modulator-receiver for modulators having high/low theta power and
% z-scores the results by using the data from the  permutation test used to
% create a null distribution for the zero-coherence hypothesis 
%
%    @ Gino Del Ferraro, November 2020, Pesaran lab, NYU
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

clear all; close all;

% set(0,'DefaultFigureVisible','off')
set(0,'DefaultFigureVisible','on')
set(0,'DefaultLineLineWidth',2)

%%%%%%%%%%%%%%%%%%%
% - LOAD DATA --- %
%%%%%%%%%%%%%%%%%%%

addpath('/mnt/pesaranlab/People/Gino/Coherence_modulator_analysis/Gino_codes');
dir_main = '/mnt/pesaranlab/People/Gino/Coherence_modulator_analysis/Shaoyu_data';
dir_high_low_theta = '/mnt/pesaranlab/People/Gino/Coherence_modulator_analysis/Shaoyu_data/Maverick/Resting_State/high_low_theta';

name_struct_input = '/session_data_lfp.mat';
filename = '.mat'; % -- filename for sess_data_info.mat
recording = 'last_recording';

freq_band = 'theta_band';
monkey = 'Maverick';
dir_RS_Theta = strcat(dir_main,sprintf('/%s/Resting_state/%s',monkey,freq_band));


fid = fopen(strcat(dir_RS_Theta,'/Sessions_with_modulator_info_movie.txt')); % load session info with no repetition
sess_info = textscan(fid,'%d%s%s'); % sess label, date, RS label
fclose(fid);

n_iter = 5000;
% p-value coherence difference for each modulator 
p_ms_tot = [];
p_mr_tot = [];

for s = 1:size(sess_info{1},1)  % For each session with at least one modulator
    
    Sess = sess_info{1}(s); % Session number
    display(['-- Session ',num2str(s),' -- label: ',num2str(Sess),', out of tot  ',num2str(size(sess_info{1},1)),' sessions'])
    dir_Sess_mod_send_data = strcat(dir_high_low_theta,sprintf('/Sess_%d/mod_send/Data',Sess));
    dir_Sess_mod_rec_data = strcat(dir_high_low_theta,sprintf('/Sess_%d/mod_rec/Data',Sess));

    % load coherence difference permuted for each session 
    load(strcat(dir_Sess_mod_send_data,'/mod_send_perm.mat'));
    load(strcat(dir_Sess_mod_rec_data,'/mod_rec_perm.mat'));
    
    for cnt_m = 1:length(mod_send_perm.mod_idx)
        
        % load coherences (high/low) for each modulator
        load(strcat(dir_Sess_mod_send_data,sprintf('/modulator_%d_send.mat',cnt_m)));
        load(strcat(dir_Sess_mod_rec_data,sprintf('/modulator_%d_rec.mat',cnt_m)));
        
        % coherence difference
        D_ms = abs(mod_send.coh_ms_high) - abs(mod_send.coh_ms_low);
        D_mr = abs(mod_rec.coh_mr_high) - abs(mod_rec.coh_mr_low);
               
        % permuted coherence difference: n_perm x freq = 5000 x 409
        PD_ms = abs(mod_send_perm.mod(cnt_m).c_ms_high) - abs(mod_send_perm.mod(cnt_m).c_ms_low);
        PD_mr = abs(mod_rec_perm.mod(cnt_m).c_mr_high) - abs(mod_rec_perm.mod(cnt_m).c_mr_low);
        
        % p-values 
        p_ms = sum(abs(PD_ms) > abs(D_ms))/n_iter;
        p_mr = sum(abs(PD_mr) > abs(D_mr))/n_iter;
        
        p_ms_tot = [p_ms_tot; p_ms];
        p_mr_tot = [p_mr_tot; p_mr];

    
    end % for each modulator



end % for each session 


z = norminv(.95);



